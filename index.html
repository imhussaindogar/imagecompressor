<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Multiple Image Optimizer ‚Äî Upload + Bulk URLs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* ---------- CSS Reset & Base ---------- */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    /* Light theme */
    --color-bg: #f8fafc;
    --color-surface: #ffffff;
    --color-surface-2: #f1f5f9;
    --color-text: #0f172a;
    --color-text-muted: #64748b;
    --color-border: #e2e8f0;
    --color-primary: #3b82f6;
    --color-primary-light: #60a5fa;
    --color-success: #10b981;
    --color-warning: #f59e0b;
    --color-error: #ef4444;
    --color-shadow: rgba(15, 23, 42, 0.1);
    --radius-lg: 16px;
    --radius-md: 12px;
    --radius-sm: 8px;
    --transition: all 0.2s ease;
  }

  [data-theme="dark"] {
    /* Dark theme */
    --color-bg: #0f172a;
    --color-surface: #1e293b;
    --color-surface-2: #334155;
    --color-text: #f1f5f9;
    --color-text-muted: #94a3b8;
    --color-border: #475569;
    --color-primary: #60a5fa;
    --color-primary-light: #93c5fd;
    --color-success: #34d399;
    --color-warning: #fbbf24;
    --color-error: #f87171;
    --color-shadow: rgba(0, 0, 0, 0.3);
  }

  html {
    height: 100%;
  }

  body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--color-bg);
    color: var(--color-text);
    line-height: 1.6;
    min-height: 100%;
    transition: var(--transition);
    padding: 20px;
  }

  #root {
    max-width: 1400px;
    margin: 0 auto;
  }

  /* ---------- Typography ---------- */
  h1 {
    font-size: 28px;
    font-weight: 700;
    line-height: 1.2;
    background: linear-gradient(135deg, var(--color-primary), var(--color-success));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  h2 {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 12px;
  }

  .subtitle {
    color: var(--color-text-muted);
    font-size: 15px;
    margin-top: 4px;
  }

  .small {
    font-size: 14px;
    color: var(--color-text-muted);
  }

  .error {
    color: var(--color-error);
    font-weight: 500;
  }

  .success {
    color: var(--color-success);
  }

  /* ---------- Layout Components ---------- */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 20px;
  }

  .header-controls {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 32px;
  }

  @media (max-width: 1024px) {
    .main-grid {
      grid-template-columns: 1fr;
    }
  }

  /* ---------- Cards ---------- */
  .card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: 24px;
    box-shadow: 0 4px 20px var(--color-shadow);
    transition: var(--transition);
  }

  .card:hover {
    box-shadow: 0 6px 30px var(--color-shadow);
  }

  /* ---------- Form Controls ---------- */
  textarea, 
  input[type="text"], 
  select {
    width: 100%;
    padding: 12px 16px;
    background: var(--color-surface-2);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-family: inherit;
    font-size: 14px;
    transition: var(--transition);
  }

  textarea:focus,
  input[type="text"]:focus,
  select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  textarea {
    min-height: 140px;
    resize: vertical;
  }

  /* ---------- Buttons ---------- */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: var(--radius-md);
    font-size: 14px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
  }

  .btn-secondary {
    background: var(--color-surface-2);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-border);
  }

  .btn-ghost {
    background: transparent;
    color: var(--color-text-muted);
    border: 1px dashed var(--color-border);
  }

  .btn-ghost:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .btn-small {
    padding: 8px 16px;
    font-size: 13px;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }

  /* ---------- Upload Area ---------- */
  .upload-area {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .upload-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  /* ---------- Drop Zone ---------- */
  .drop-zone {
    border: 3px dashed var(--color-border);
    border-radius: var(--radius-md);
    padding: 40px 20px;
    text-align: center;
    background: var(--color-surface-2);
    cursor: pointer;
    transition: var(--transition);
    margin-top: 16px;
  }

  .drop-zone:hover {
    border-color: var(--color-primary);
    background: rgba(59, 130, 246, 0.05);
  }

  .drop-zone.drag-over {
    border-color: var(--color-primary);
    background: rgba(59, 130, 246, 0.1);
    transform: scale(1.02);
  }

  .drop-zone-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .drop-zone-icon {
    font-size: 48px;
    color: var(--color-primary);
  }

  /* ---------- Controls ---------- */
  .controls {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .slider-container {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  input[type="range"] {
    flex: 1;
    height: 6px;
    -webkit-appearance: none;
    background: var(--color-border);
    border-radius: 3px;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: var(--color-primary);
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid var(--color-surface);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  .quality-value {
    min-width: 60px;
    text-align: center;
    font-weight: 600;
    color: var(--color-primary);
  }

  /* ---------- Preview List ---------- */
  .preview-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .preview-count {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .count-badge {
    background: var(--color-primary);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
  }

  /* ---------- Preview Items ---------- */
  .preview-item {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: 20px;
    transition: var(--transition);
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .preview-item:hover {
    border-color: var(--color-primary);
    box-shadow: 0 4px 15px var(--color-shadow);
  }

  .preview-grid {
    display: grid;
    grid-template-columns: 180px 1fr;
    gap: 20px;
    align-items: start;
  }

  @media (max-width: 768px) {
    .preview-grid {
      grid-template-columns: 1fr;
    }
  }

  .preview-image {
    width: 100%;
    height: 120px;
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: var(--color-surface-2);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .preview-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .preview-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .preview-header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
  }

  .file-info {
    flex: 1;
    min-width: 0;
  }

  .file-name {
    font-weight: 600;
    margin-bottom: 4px;
    word-break: break-all;
  }

  .file-meta {
    display: flex;
    gap: 12px;
    color: var(--color-text-muted);
    font-size: 14px;
  }

  .tag {
    padding: 4px 10px;
    background: var(--color-surface-2);
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-weight: 500;
  }

  .status-badge {
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-pending {
    background: rgba(245, 158, 11, 0.1);
    color: var(--color-warning);
  }

  .status-loading {
    background: rgba(59, 130, 246, 0.1);
    color: var(--color-primary);
  }

  .status-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--color-success);
  }

  .status-error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--color-error);
  }

  /* ---------- Optimization Panel ---------- */
  .optimization-panel {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 20px;
    align-items: center;
    margin-top: 16px;
    padding: 16px;
    background: var(--color-surface-2);
    border-radius: var(--radius-md);
  }

  @media (max-width: 640px) {
    .optimization-panel {
      grid-template-columns: 1fr;
    }
  }

  .optimization-info {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .optimization-stats {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }

  .optimization-actions {
    display: flex;
    gap: 12px;
  }

  /* ---------- URL Status Items ---------- */
  .url-status-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: var(--color-surface-2);
    border-radius: var(--radius-md);
    margin-bottom: 12px;
  }

  .url-status-icon {
    font-size: 24px;
  }

  .url-status-content {
    flex: 1;
  }

  .url-text {
    font-family: monospace;
    font-size: 13px;
    word-break: break-all;
    margin-bottom: 4px;
  }

  /* ---------- Footer ---------- */
  .footer {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
  }

  .footer-info {
    color: var(--color-text-muted);
    font-size: 14px;
  }

  .footer-actions {
    display: flex;
    gap: 12px;
  }

  /* ---------- Utility Classes ---------- */
  .hidden {
    display: none !important;
  }

  .text-center {
    text-align: center;
  }

  .mt-2 { margin-top: 8px; }
  .mt-4 { margin-top: 16px; }
  .mt-6 { margin-top: 24px; }
  .mb-2 { margin-bottom: 8px; }
  .mb-4 { margin-bottom: 16px; }
  .gap-2 { gap: 8px; }
  .gap-4 { gap: 16px; }

  /* ---------- Loading Animation ---------- */
  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ---------- Progress Bar ---------- */
  .progress-bar {
    width: 100%;
    height: 4px;
    background: var(--color-border);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 8px;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-success));
    transition: width 0.3s ease;
  }

  /* ---------- Empty States ---------- */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--color-text-muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* ---------- Theme Toggle ---------- */
  .theme-toggle {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    background: var(--color-surface-2);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    cursor: pointer;
    transition: var(--transition);
  }

  .theme-toggle:hover {
    background: var(--color-border);
  }

  .theme-icon {
    font-size: 20px;
  }

  /* ---------- File Upload Label ---------- */
  .file-upload-label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: var(--color-surface-2);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition);
  }

  .file-upload-label:hover {
    background: var(--color-border);
  }

  .file-upload-label input {
    display: none;
  }

  /* ---------- Alert ---------- */
  .alert {
    padding: 16px;
    border-radius: var(--radius-md);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .alert-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid var(--color-error);
    color: var(--color-error);
  }

  .alert-success {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid var(--color-success);
    color: var(--color-success);
  }

  /* ---------- Modal ---------- */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }

  .modal {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    padding: 32px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    font-size: 24px;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
  }

  .modal-close:hover {
    background: var(--color-surface-2);
  }
</style>
</head>
<body>
  <div id="root" data-theme="dark">
    <!-- Header -->
    <header class="header">
      <div>
        <h1>Multiple Image Optimizer</h1>
        <div class="subtitle">Upload images, paste bulk URLs, convert/compress and download individually or as ZIP</div>
      </div>
      
      <div class="header-controls">
        <div class="theme-toggle" id="themeToggle">
          <span class="theme-icon">üåô</span>
          <span id="themeLabel">Dark Mode</span>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="main-grid">
      <!-- Left Column: URL Input -->
      <div class="card">
        <h2>Add Image URLs</h2>
        <div class="upload-area">
          <textarea 
            id="urlArea" 
            placeholder="Paste image URLs (one per line)&#10;Example:&#10;https://example.com/image1.jpg&#10;https://example.com/image2.png"
            class="mb-4"
          ></textarea>
          
          <div class="upload-buttons">
            <button id="addUrlsBtn" class="btn btn-primary">
              <span>Add URLs</span>
            </button>
            
            <label class="file-upload-label">
              <input type="file" id="urlFile" accept=".txt,.csv" hidden>
              üìÑ Upload URL List
            </label>
          </div>
        </div>
      </div>

      <!-- Right Column: Upload & Settings -->
      <div class="card">
        <h2>Upload & Settings</h2>
        
        <div class="controls">
          <div class="control-group">
            <label class="small">Upload Local Images</label>
            <div class="drop-zone" id="dropZone">
              <div class="drop-zone-content">
                <div class="drop-zone-icon">üìÅ</div>
                <div>Drag & drop images here</div>
                <div class="small">or click to browse</div>
              </div>
            </div>
            <input type="file" id="upload" accept="image/*" multiple hidden>
          </div>

          <div class="control-group">
            <label class="small">Output Format</label>
            <select id="format">
              <option value="image/webp">WebP (Recommended)</option>
              <option value="image/jpeg">JPEG</option>
              <option value="image/png">PNG</option>
            </select>
          </div>

          <div class="control-group">
            <label class="small">Quality: <span id="qualityValue">80%</span></label>
            <div class="slider-container">
              <input type="range" id="quality" min="10" max="100" step="5" value="80">
            </div>
          </div>

          <button id="optimizeBtn" class="btn btn-primary">
            <span>‚ú® Optimize All Images</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Preview Container -->
    <div class="card">
      <div class="preview-header">
        <div class="preview-count">
          <h2>Images</h2>
          <span class="count-badge" id="imageCount">0</span>
        </div>
        <div class="small" id="infoText">No images loaded</div>
      </div>

      <div class="preview-container" id="previewContainer">
        <!-- Images will be inserted here -->
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-info">
        <div>Ready to download optimized images</div>
        <div class="small mt-2">Images will be saved with original names</div>
      </div>
      
      <div class="footer-actions">
        <button id="downloadAllBtn" class="btn btn-ghost hidden">
          üì¶ Download All as ZIP
        </button>
        <button id="clearBtn" class="btn btn-secondary">
          üóëÔ∏è Clear All
        </button>
      </div>
    </footer>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
  (function(){
    // ---------- State ----------
    let allFiles = [];
    let optimizedBlobs = [];
    let urlStatuses = new Map();
    let currentOptimization = null;

    // ---------- DOM Elements ----------
    const root = document.getElementById('root');
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const urlArea = document.getElementById('urlArea');
    const addUrlsBtn = document.getElementById('addUrlsBtn');
    const urlFile = document.getElementById('urlFile');
    const uploadInput = document.getElementById('upload');
    const dropZone = document.getElementById('dropZone');
    const previewContainer = document.getElementById('previewContainer');
    const optimizeBtn = document.getElementById('optimizeBtn');
    const formatSelect = document.getElementById('format');
    const qualityInput = document.getElementById('quality');
    const qualityValue = document.getElementById('qualityValue');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const clearBtn = document.getElementById('clearBtn');
    const imageCount = document.getElementById('imageCount');
    const infoText = document.getElementById('infoText');
    const alertContainer = document.getElementById('alertContainer');

    // ---------- Theme Management ----------
    function initTheme() {
      const savedTheme = localStorage.getItem('imgopt_theme') || 'dark';
      root.setAttribute('data-theme', savedTheme);
      updateThemeUI(savedTheme);
    }

    function updateThemeUI(theme) {
      const isDark = theme === 'dark';
      themeLabel.textContent = isDark ? 'Dark Mode' : 'Light Mode';
      themeToggle.querySelector('.theme-icon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    }

    themeToggle.addEventListener('click', () => {
      const currentTheme = root.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      root.setAttribute('data-theme', newTheme);
      localStorage.setItem('imgopt_theme', newTheme);
      updateThemeUI(newTheme);
    });

    // ---------- Alert System ----------
    function showAlert(message, type = 'error', duration = 5000) {
      const alertEl = document.createElement('div');
      alertEl.className = `alert alert-${type}`;
      alertEl.innerHTML = `
        ${type === 'error' ? '‚ùå' : '‚úÖ'}
        <div>${message}</div>
      `;
      
      alertContainer.appendChild(alertEl);
      
      if (duration > 0) {
        setTimeout(() => {
          alertEl.style.opacity = '0';
          setTimeout(() => alertEl.remove(), 300);
        }, duration);
      }
    }

    // ---------- File Handling ----------
    function handleFileSelect(files) {
      const imageFiles = Array.from(files).filter(f => 
        f.type.startsWith('image/')
      );
      
      if (imageFiles.length === 0) {
        showAlert('No image files found in selection');
        return;
      }
      
      allFiles.push(...imageFiles);
      updateUI();
      showAlert(`Added ${imageFiles.length} image(s)`, 'success');
    }

    // ---------- URL Processing ----------
    async function processURLs() {
      const text = urlArea.value.trim();
      if (!text) {
        showAlert('Please paste some URLs first');
        return;
      }

      const urls = text.split(/\r?\n|,/).map(s => s.trim()).filter(Boolean);
      if (urls.length === 0) {
        showAlert('No valid URLs found');
        return;
      }

      urlArea.value = '';
      addUrlsBtn.disabled = true;
      addUrlsBtn.innerHTML = '<span class="spinner"></span> Processing...';

      const uniqueUrls = [...new Set(urls)];
      let successCount = 0;
      let failCount = 0;

      for (const url of uniqueUrls) {
        try {
          addUrlStatus(url, 'pending', 'Waiting...');
          
          const response = await fetch(url, { 
            mode: 'cors',
            headers: { 'User-Agent': 'Mozilla/5.0' }
          });
          
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          
          const blob = await response.blob();
          if (!blob.type.startsWith('image/')) throw new Error('Not an image');
          
          const filename = extractFilenameFromURL(url) || `image-${Date.now()}.${blob.type.split('/')[1]}`;
          const file = new File([blob], filename, { type: blob.type });
          
          allFiles.push(file);
          updateUrlStatus(url, 'success', 'Downloaded successfully');
          successCount++;
          
        } catch (error) {
          console.warn('Failed to fetch URL:', url, error);
          updateUrlStatus(url, 'error', error.message);
          failCount++;
        }
      }

      updateUI();
      addUrlsBtn.disabled = false;
      addUrlsBtn.textContent = 'Add URLs';

      if (successCount > 0) {
        showAlert(`Successfully added ${successCount} image(s)${failCount > 0 ? `, ${failCount} failed` : ''}`, 
                 failCount > 0 ? 'error' : 'success');
      }
    }

    function extractFilenameFromURL(url) {
      try {
        const urlObj = new URL(url);
        const pathname = urlObj.pathname;
        const filename = pathname.split('/').pop();
        return filename || null;
      } catch {
        return null;
      }
    }

    // ---------- URL Status Management ----------
    function addUrlStatus(url, status, message) {
      urlStatuses.set(url, { status, message });
      renderUrlStatus(url);
    }

    function updateUrlStatus(url, status, message) {
      const existing = urlStatuses.get(url);
      if (existing) {
        existing.status = status;
        existing.message = message;
        renderUrlStatus(url);
      }
    }

    function renderUrlStatus(url) {
      const status = urlStatuses.get(url);
      if (!status) return;

      const existingEl = document.querySelector(`[data-url="${CSS.escape(url)}"]`);
      
      const statusEl = existingEl || document.createElement('div');
      statusEl.className = 'url-status-item';
      statusEl.dataset.url = url;
      
      const statusIcon = {
        pending: '‚è≥',
        loading: 'üîÑ',
        success: '‚úÖ',
        error: '‚ùå'
      }[status.status] || '‚ùì';
      
      statusEl.innerHTML = `
        <div class="url-status-icon">${statusIcon}</div>
        <div class="url-status-content">
          <div class="url-text">${url}</div>
          <div class="small">${status.message}</div>
        </div>
        ${status.status === 'error' ? 
          `<button class="btn btn-small btn-secondary" data-retry-url="${encodeURIComponent(url)}">Retry</button>` : 
          ''
        }
      `;
      
      if (!existingEl) {
        previewContainer.appendChild(statusEl);
      }

      // Add retry handler
      const retryBtn = statusEl.querySelector(`[data-retry-url]`);
      if (retryBtn) {
        retryBtn.onclick = () => retryUrl(url);
      }
    }

    async function retryUrl(url) {
      try {
        updateUrlStatus(url, 'loading', 'Retrying...');
        const response = await fetch(url, { mode: 'cors' });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const blob = await response.blob();
        if (!blob.type.startsWith('image/')) throw new Error('Not an image');
        
        const filename = extractFilenameFromURL(url) || `image-${Date.now()}.${blob.type.split('/')[1]}`;
        const file = new File([blob], filename, { type: blob.type });
        
        allFiles.push(file);
        updateUrlStatus(url, 'success', 'Downloaded successfully');
        updateUI();
        showAlert('URL retry successful', 'success');
        
      } catch (error) {
        updateUrlStatus(url, 'error', error.message);
        showAlert('Retry failed: ' + error.message);
      }
    }

    // ---------- Optimization ----------
    async function optimizeAllImages() {
      if (allFiles.length === 0) {
        showAlert('No images to optimize');
        return;
      }

      optimizeBtn.disabled = true;
      optimizeBtn.innerHTML = '<span class="spinner"></span> Optimizing...';
      optimizedBlobs = [];
      
      const outputFormat = formatSelect.value;
      const quality = outputFormat === 'image/png' ? undefined : (qualityInput.value / 100);
      
      let successCount = 0;
      let failCount = 0;

      for (let i = 0; i < allFiles.length; i++) {
        const file = allFiles[i];
        const previewItem = document.querySelector(`[data-file-index="${i}"]`);
        
        if (previewItem) {
          const statusEl = previewItem.querySelector('.optimization-status');
          if (statusEl) {
            statusEl.textContent = 'Optimizing...';
            statusEl.className = 'status-badge status-loading';
          }
        }

        try {
          const result = await optimizeImage(file, outputFormat, quality);
          optimizedBlobs.push(result);
          successCount++;
          
          if (previewItem) {
            updatePreviewOptimization(previewItem, result);
          }
        } catch (error) {
          console.error('Optimization failed:', error);
          failCount++;
          
          if (previewItem) {
            const statusEl = previewItem.querySelector('.optimization-status');
            if (statusEl) {
              statusEl.textContent = 'Failed';
              statusEl.className = 'status-badge status-error';
            }
          }
        }
      }

      optimizeBtn.disabled = false;
      optimizeBtn.textContent = '‚ú® Optimize All Images';
      
      downloadAllBtn.classList.remove('hidden');
      
      showAlert(
        `Optimization complete: ${successCount} successful, ${failCount} failed`,
        failCount === 0 ? 'success' : 'error'
      );
    }

    async function optimizeImage(file, outputFormat, quality) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const objectUrl = URL.createObjectURL(file);
        
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          
          canvas.toBlob(
            (blob) => {
              URL.revokeObjectURL(objectUrl);
              
              if (!blob) {
                reject(new Error('Failed to create blob'));
                return;
              }
              
              // Preserve original filename with new extension
              const originalName = file.name.replace(/\.[^/.]+$/, '');
              const extension = outputFormat.split('/')[1];
              const newFilename = `${originalName}.${extension}`;
              
              resolve({
                blob,
                filename: newFilename,
                originalSize: file.size,
                optimizedSize: blob.size,
                reduction: ((file.size - blob.size) / file.size * 100).toFixed(1)
              });
            },
            outputFormat,
            quality
          );
        };
        
        img.onerror = () => {
          URL.revokeObjectURL(objectUrl);
          reject(new Error('Failed to load image'));
        };
        
        img.src = objectUrl;
      });
    }

    // ---------- UI Updates ----------
    function updateUI() {
      imageCount.textContent = allFiles.length;
      infoText.textContent = allFiles.length === 0 
        ? 'No images loaded' 
        : `${allFiles.length} image(s) ready for optimization`;
      
      renderFilePreviews();
    }

    function renderFilePreviews() {
      // Clear only file previews, keep URL status items
      const filePreviews = previewContainer.querySelectorAll('[data-file-index]');
      filePreviews.forEach(el => el.remove());
      
      // Render all files
      allFiles.forEach((file, index) => {
        const previewEl = createFilePreview(file, index);
        previewContainer.appendChild(previewEl);
      });
    }

    function createFilePreview(file, index) {
      const objectUrl = URL.createObjectURL(file);
      const previewEl = document.createElement('div');
      previewEl.className = 'preview-item';
      previewEl.dataset.fileIndex = index;
      
      const optimizedData = optimizedBlobs[index];
      
      previewEl.innerHTML = `
        <div class="preview-grid">
          <div class="preview-image">
            <img src="${objectUrl}" alt="${file.name}" loading="lazy">
          </div>
          
          <div class="preview-content">
            <div class="preview-header-row">
              <div class="file-info">
                <div class="file-name">${escapeHtml(file.name)}</div>
                <div class="file-meta">
                  <span>${(file.size / 1024).toFixed(1)} KB</span>
                  <span>‚Ä¢</span>
                  <span>${file.type || 'Unknown'}</span>
                </div>
              </div>
              
              <div class="status-badge ${optimizedData ? 'status-success' : 'status-pending'} optimization-status">
                ${optimizedData ? 'Optimized' : 'Pending'}
              </div>
            </div>
            
            ${optimizedData ? `
              <div class="optimization-panel">
                <div class="optimization-info">
                  <div class="optimization-stats">
                    <span class="success">‚Üì ${optimizedData.reduction}%</span>
                    <span>‚Ä¢</span>
                    <span>${(optimizedData.optimizedSize / 1024).toFixed(1)} KB</span>
                  </div>
                  <div class="small">${formatSelect.value.split('/')[1].toUpperCase()}</div>
                </div>
                
                <div class="optimization-actions">
                  <a href="${URL.createObjectURL(optimizedData.blob)}" 
                     download="${optimizedData.filename}"
                     class="btn btn-small btn-primary">
                    ‚¨áÔ∏è Download
                  </a>
                </div>
              </div>
            ` : ''}
            
            <div class="file-actions mt-4">
              <button class="btn btn-small btn-secondary" data-remove="${index}">
                Remove
              </button>
              <button class="btn btn-small btn-secondary" data-preview="${index}">
                Preview
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Add event listeners
      const removeBtn = previewEl.querySelector('[data-remove]');
      const previewBtn = previewEl.querySelector('[data-preview]');
      
      removeBtn.addEventListener('click', () => {
        allFiles.splice(index, 1);
        optimizedBlobs.splice(index, 1);
        updateUI();
      });
      
      previewBtn.addEventListener('click', () => {
        window.open(objectUrl, '_blank');
      });
      
      return previewEl;
    }

    function updatePreviewOptimization(previewEl, result) {
      const statusEl = previewEl.querySelector('.optimization-status');
      const optimizationPanel = previewEl.querySelector('.optimization-panel');
      
      if (statusEl) {
        statusEl.textContent = 'Optimized';
        statusEl.className = 'status-badge status-success';
      }
      
      if (!optimizationPanel) {
        const contentDiv = previewEl.querySelector('.preview-content');
        const optimizationHtml = `
          <div class="optimization-panel">
            <div class="optimization-info">
              <div class="optimization-stats">
                <span class="success">‚Üì ${result.reduction}%</span>
                <span>‚Ä¢</span>
                <span>${(result.optimizedSize / 1024).toFixed(1)} KB</span>
              </div>
              <div class="small">${formatSelect.value.split('/')[1].toUpperCase()}</div>
            </div>
            
            <div class="optimization-actions">
              <a href="${URL.createObjectURL(result.blob)}" 
                 download="${result.filename}"
                 class="btn btn-small btn-primary">
                ‚¨áÔ∏è Download
              </a>
            </div>
          </div>
        `;
        
        const fileActions = previewEl.querySelector('.file-actions');
        if (fileActions) {
          fileActions.insertAdjacentHTML('beforebegin', optimizationHtml);
        }
      }
    }

    // ---------- Download All ----------
    async function downloadAllAsZip() {
      if (optimizedBlobs.length === 0) {
        showAlert('No optimized images to download');
        return;
      }

      downloadAllBtn.disabled = true;
      downloadAllBtn.innerHTML = '<span class="spinner"></span> Creating ZIP...';

      try {
        const zip = new JSZip();
        
        optimizedBlobs.forEach(item => {
          zip.file(item.filename, item.blob);
        });
        
        const content = await zip.generateAsync({ type: 'blob' });
        saveAs(content, `optimized-images-${Date.now()}.zip`);
        
        showAlert('ZIP file created successfully!', 'success');
      } catch (error) {
        console.error('ZIP creation failed:', error);
        showAlert('Failed to create ZIP file');
      } finally {
        downloadAllBtn.disabled = false;
        downloadAllBtn.textContent = 'üì¶ Download All as ZIP';
      }
    }

    // ---------- Event Listeners ----------
    function initEventListeners() {
      // Quality slider
      qualityInput.addEventListener('input', () => {
        qualityValue.textContent = `${qualityInput.value}%`;
      });

      // URL processing
      addUrlsBtn.addEventListener('click', processURLs);
      
      urlFile.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          const text = await file.text();
          urlArea.value = text;
          await processURLs();
        } catch (error) {
          showAlert('Failed to read URL file');
        }
        
        urlFile.value = '';
      });

      // File upload
      uploadInput.addEventListener('change', (e) => {
        handleFileSelect(e.target.files);
        uploadInput.value = '';
      });

      // Drag and drop
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });

      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        handleFileSelect(e.dataTransfer.files);
      });

      dropZone.addEventListener('click', () => {
        uploadInput.click();
      });

      // Optimization
      optimizeBtn.addEventListener('click', optimizeAllImages);

      // Download all
      downloadAllBtn.addEventListener('click', downloadAllAsZip);

      // Clear all
      clearBtn.addEventListener('click', () => {
        if (allFiles.length === 0 && urlStatuses.size === 0) {
          showAlert('Nothing to clear');
          return;
        }

        if (confirm('Clear all images and results?')) {
          allFiles = [];
          optimizedBlobs = [];
          urlStatuses.clear();
          updateUI();
          previewContainer.innerHTML = '';
          downloadAllBtn.classList.add('hidden');
          showAlert('All cleared', 'success');
        }
      });
    }

    // ---------- Utility Functions ----------
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ---------- Initialization ----------
    function init() {
      initTheme();
      initEventListeners();
      updateUI();
    }

    // Start the application
    init();
  })();
  </script>
</body>
</html>
